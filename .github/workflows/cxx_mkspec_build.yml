name: C++ make-specs Build
on: [push, pull_request]
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        config:
        - cxx_mkspec: cxx_msvc16_x86
          name: MSVC 16 32-bit
        - cxx_mkspec: cxx_msvc16_x64
          name: MSVC 16 64-bit
        - cxx_mkspec: cxx_apple_llvm120_x64
          name: Apple LLVM 12.0 64-bit
        - cxx_mkspec: cxx_clang70_x64
          name: Clang 7.0 64-Bit
        - cxx_mkspec: cxx_clang70_x86
          name: Clang 7.0 32-Bit
        - cxx_mkspec: cxx_gxx83_x64
          name: GCC 8.3 64-Bit
        - cxx_mkspec: cxx_gxx83_x86
          name: GCC 8.3 32-Bit
    runs-on: [self-hosted, '${{ matrix.cxx_mkspec }}']
    name: ${{ matrix.config.name }}
    env:
      python: python3
    steps:
      - name: Rename python3 to python on Windows
        if: runner.os == 'Windows'
        run: echo "python=python" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
      - name: Checkout
        uses: actions/checkout@v2
      - name: Configure
        run: ${{ env.python }} waf configure --git_protocol=git@ --cxx_mkspec=${{ matrix.config.cxx_mkspec }}
      - name: Build
        run: |
          echo "::add-matcher::.github/gcc-problem-matcher.json"
          ${{ env.python }} waf
      - name: Test
        run: ${{ env.python }} waf --run_tests
