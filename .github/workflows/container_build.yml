name: Container Build
on: [push, pull_request]
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        config:
        - container: conanio/gcc5
          cxx_mkspec: --cxx_mkspec=cxx_gxx54_x64
          name: GCC 5.4
        - container: conanio/gcc9
          cxx_mkspec: --cxx_mkspec=cxx_gxx92_x64
          name: GCC 9.2
        - container: conanio/clang39
          name: Clang 3.9
          cxx_mkspec: --cxx_mkspec=cxx_clang39_x64
        - container: conanio/clang10
          name: Clang 10
        - container: conanio/clang10
          cxx_mkspec: --cxx_mkspec=cxx_clang10_address_sanitizer_x64
          name: Clang 10 Address Sanitizer
        - container: conanio/clang10
          cxx_mkspec: --cxx_mkspec=cxx_clang10_memory_sanitizer_x64
          name: Clang 10 Memory Sanitizer
        - container: conanio/clang10
          cxx_mkspec: --cxx_mkspec=cxx_clang10_thread_sanitizer_x64
          name: Clang 10 Thread Sanitizer
    runs-on: [self-hosted, docker]
    name: ${{ matrix.config.name }}
    container:
      image: ${{ matrix.config.container }}
      options: --user 0:0
      volumes:
        - /home/buildbot/.ssh:/root/.ssh
    steps:
      - name: Install SSH client
        run: apt update && apt -y install openssh-client
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: Waf Configure
        run: python3 waf configure --git_protocol=git@ ${{ matrix.config.cxx_mkspec }}
      - name: Waf Build
        run: |
          echo "::add-matcher::.github/gcc-problem-matcher.json"
          python3 waf
      - name: Waf Test
        run: python3 waf --run_tests
